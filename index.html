<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#dc3545">
    <title>RestoApp - Sistema de Gestión de Restaurante</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuración y Servicios de Supabase -->
    <script src="config.js"></script>
    <script src="supabase-service.js"></script>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <i class="fas fa-utensils"></i>
                    <h1>RestoApp</h1>
                    <p>Sistema de Gestión de Restaurante</p>
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Usuario</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Pantalla del Mozo -->
    <div id="mozoScreen" class="screen">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="fas fa-user-tie"></i> RestoApp - Mozo
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </nav>

        <div class="container-fluid mt-3">
            <!-- Panel de Mesas (Vista principal móvil) -->
            <div id="panelMesas">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-table"></i> Seleccionar Mesa</h5>
                    </div>
                    <div class="card-body">
                        <div id="mesasGrid" class="mesas-grid"></div>
                    </div>
                </div>
            </div>

            <!-- Panel de Pedido (Se muestra al seleccionar mesa) -->
            <div id="panelPedido" style="display: none;">
                <div class="mb-3">
                    <button class="btn btn-outline-danger" onclick="volverAMesas()">
                        <i class="fas fa-arrow-left"></i> Volver a Mesas
                    </button>
                    <span class="ms-3 fw-bold text-white">
                        <i class="fas fa-chair"></i> <span id="mesaSeleccionada">Mesa</span>
                    </span>
                </div>
                
                <div class="row">
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-book-open"></i> Menú</h5>
                            </div>
                            <div class="card-body">
                                <div id="menuItems"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-receipt"></i> Pedido Actual</h5>
                            </div>
                            <div class="card-body">
                                <!-- Pedido existente de la mesa -->
                                <div id="pedidoExistente"></div>
                                
                                <!-- Separador si hay pedido existente -->
                                <div id="separadorPedido" style="display: none;">
                                    <hr>
                                    <h6 class="text-center text-muted mb-3">
                                        <i class="fas fa-plus"></i> Nuevos Items
                                    </h6>
                                </div>
                                
                                <!-- Items nuevos que se están agregando -->
                                <div id="pedidoActual"></div>
                                
                                <div class="pedido-total mt-3">
                                    <h5>Total: $<span id="totalPedido">0</span></h5>
                                </div>
                                <button id="btnEnviarPedido" class="btn btn-success w-100 mt-3">
                                    <i class="fas fa-paper-plane"></i> Enviar a Cocina
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Cocina -->
    <div id="cocinaScreen" class="screen">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="fas fa-fire-burner"></i> RestoApp - Cocina
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </nav>

        <div class="container-fluid mt-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-list"></i> Comandas Pendientes</h5>
                </div>
                <div class="card-body">
                    <div id="comandasLista" class="row"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Caja -->
    <div id="cajaScreen" class="screen">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="fas fa-cash-register"></i> RestoApp - Caja / Admin
                </span>
                <div>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="toggleVistaAnalytics()">
                        <i class="fas fa-chart-line"></i> <span id="btnAnalyticsText">Analytics</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="toggleVistaAdmin()">
                        <i class="fas fa-cog"></i> <span id="btnToggleText">Productos</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="toggleVistaUsuarios()">
                        <i class="fas fa-users"></i> <span id="btnUsuariosText">Usuarios</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid mt-4">
            <!-- Vista de Caja (Mesas y Ventas) -->
            <div id="vistaCaja">
                <div class="row">
                    <!-- Mesas -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-table"></i> Estado de Mesas</h5>
                            </div>
                            <div class="card-body">
                                <div id="mesasCaja" class="mesas-grid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Detalle de Cuenta -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-file-invoice-dollar"></i> Detalle de Cuenta</h5>
                            </div>
                            <div class="card-body">
                                <div id="detalleCuenta"></div>
                                <div id="totalCuenta" class="mt-3"></div>
                                <button id="btnFinalizarVenta" class="btn btn-success w-100 mt-3" disabled>
                                    <i class="fas fa-check-circle"></i> Finalizar Venta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista Analytics -->
            <div id="vistaAnalytics" style="display: none;">
                <div class="row mb-4">
                    <div class="col-12">
                        <h3><i class="fas fa-chart-line"></i> Analytics del Día</h3>
                        <p class="text-muted" id="fechaActual"></p>
                    </div>
                </div>

                <!-- Tarjetas de estadísticas -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-success">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h5>Total Ventas</h5>
                                <h3 id="totalVentas">$0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-info">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="stat-info">
                                <h5>N° Órdenes</h5>
                                <h3 id="numOrdenes">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-warning">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="stat-info">
                                <h5>Ticket Promedio</h5>
                                <h3 id="ticketPromedio">$0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-danger">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="stat-info">
                                <h5>Items Vendidos</h5>
                                <h3 id="itemsVendidos">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de ventas del día -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-list"></i> Detalle de Ventas del Día</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Hora</th>
                                                <th>Mesa</th>
                                                <th>Items</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaVentasHoy">
                                            <tr>
                                                <td colspan="4" class="text-center">No hay ventas registradas hoy</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón Cerrar Caja -->
                <div class="row">
                    <div class="col-12 text-center">
                        <button class="btn btn-danger btn-lg" onclick="cerrarCaja()">
                            <i class="fas fa-lock"></i> Cerrar Caja del Día
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vista de Administración de Productos -->
            <div id="vistaAdmin" style="display: none;">
                <div class="row">
                    <!-- Formulario de Producto -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-plus-circle"></i> <span id="formTitulo">Agregar Producto</span></h5>
                            </div>
                            <div class="card-body">
                                <form id="formProducto">
                                    <input type="hidden" id="productoId">
                                    <input type="hidden" id="editandoProducto" value="false">
                                    
                                    <div class="mb-3">
                                        <label for="productoCategoria" class="form-label">Categoría</label>
                                        <select class="form-select" id="productoCategoria" required>
                                            <option value="">Seleccione una categoría</option>
                                            <option value="Entradas">Entradas</option>
                                            <option value="Platos Principales">Platos Principales</option>
                                            <option value="Bebidas">Bebidas</option>
                                            <option value="Postres">Postres</option>
                                            <option value="nueva">+ Nueva Categoría</option>
                                        </select>
                                    </div>

                                    <div class="mb-3" id="nuevaCategoriaDiv" style="display: none;">
                                        <label for="nuevaCategoria" class="form-label">Nombre de Nueva Categoría</label>
                                        <input type="text" class="form-control" id="nuevaCategoria">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="productoNombre" class="form-label">Nombre del Producto</label>
                                        <input type="text" class="form-control" id="productoNombre" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="productoPrecio" class="form-label">Precio ($)</label>
                                        <input type="number" class="form-control" id="productoPrecio" step="0.01" min="0" required>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="fas fa-save"></i> <span id="btnGuardarText">Guardar Producto</span>
                                    </button>
                                    <button type="button" class="btn btn-secondary w-100 mt-2" id="btnCancelarEdicion" style="display: none;" onclick="cancelarEdicion()">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Productos -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-list"></i> Productos del Menú</h5>
                            </div>
                            <div class="card-body">
                                <div id="listaProductosAdmin"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista de Administración de Usuarios -->
            <div id="vistaUsuarios" style="display: none;">
                <div class="row">
                    <!-- Formulario de Usuario -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-user-plus"></i> <span id="formUsuarioTitulo">Agregar Usuario</span></h5>
                            </div>
                            <div class="card-body">
                                <form id="formUsuario">
                                    <input type="hidden" id="usuarioId">
                                    <input type="hidden" id="editandoUsuario" value="false">
                                    
                                    <div class="mb-3">
                                        <label for="usuarioUsername" class="form-label">Nombre de Usuario</label>
                                        <input type="text" class="form-control" id="usuarioUsername" required>
                                        <small class="text-muted">Sin espacios ni caracteres especiales</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="usuarioPassword" class="form-label">Contraseña</label>
                                        <input type="password" class="form-control" id="usuarioPassword" required>
                                        <small class="text-muted">Mínimo 4 caracteres</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="usuarioRole" class="form-label">Rol</label>
                                        <select class="form-select" id="usuarioRole" required>
                                            <option value="">Seleccione un rol</option>
                                            <option value="mozo">Mozo</option>
                                            <option value="cocina">Cocina</option>
                                            <option value="caja">Caja/Administrador</option>
                                        </select>
                                        <small class="text-muted">Define los permisos del usuario</small>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="fas fa-save"></i> <span id="btnGuardarUsuarioText">Guardar Usuario</span>
                                    </button>
                                    <button type="button" class="btn btn-secondary w-100 mt-2" id="btnCancelarUsuario" style="display: none;" onclick="cancelarEdicionUsuario()">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Usuarios -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-users"></i> Usuarios del Sistema</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    Gestione los usuarios que pueden acceder al sistema. Cada usuario tiene un rol específico con permisos diferentes.
                                </div>
                                <div id="listaUsuarios"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
